<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magadan 2077</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <script src="scripts/vector2d.js"></script>
    <script src="scripts/Render.js"></script>
    <script src="scripts/line.js"></script>
    <script src="scripts/globals.js"></script>
    
    <canvas id="cnvs" class="container flex center"></canvas>

    <script>
        alert(document.documentElement.clientHeight + " " + document.documentElement.clientWidth)
        HEIGHT = document.documentElement.clientHeight;
        WIDTH = document.documentElement.clientWidth;
        var canvas=document.getElementById('cnvs');
        var ctx = canvas.getContext('2d');   

        canvas.setAttribute('height', HEIGHT);
        canvas.setAttribute('width', WIDTH);


        // Создаем объект изображения
        var img = new Image();
        var sonic = new Image();
        var car = new Image();

        // Привязываем функцию к событию onload
        // Это указывает браузеру, что делать, когда изображение загружено
        img.onload = function() {
            ctx.drawImage(img, 0, 0, 1920, 500);
        };

        // Загружаем файл изображения
        img.src = 'image/bg.png';
        
        let lines = [];
        for(let i = 0; i < 600; i++)
        {
            let line = new Line();
            line.z = i * SEGL;
            
            if(i > 50 && i < 100) {line.curve = 2;}
            if(i > 120 && i < 170) {line.curve = -2;}
            if(i > 190 && i < 230) {line.curve = 3;}
            if(i > 250 && i < 300) {line.curve = 5;}
            if(i > 300 && i < 400) {line.curve = -5;}
            if(i > 400 && i < 450) {line.curve = 3;}
            if(i > 500 && i < 600) {line.curve = -3;}
            
            
            
            // if(i > 750) {line.y = Math.sin(i/30.0) * 1500;} | Холмы
            
            
            lines.push(line);
        }
        
        /////////////////////////////
        
        var pos = 0;
        var playerX = 0;
        var z = 0;
        setInterval(onTimerTick, 33);
        
        /////////////////////////////
        
        var press = false;
        
        function onTimerTick() {
            var N = lines.length;
            var maxy = HEIGHT;
            z++;
            car.src = 'image/car.png';
            document.onkeydown = checkKey;
            function checkKey(e) {
                press = true;
                console.log(press);
                
                e = e || window.event;
                
                if (e.keyCode == '37' && playerX > -5000) 
                {
                    playerX -= 300
                    sonic.src = 'image/player_left.png';
                    
                    console.log('left' + playerX);
                }
                else if (e.keyCode == '39' && playerX < 5000) 
                {
                    playerX += 300;
                    sonic.src = 'image/player_right.png';
                    
                    console.log('right' + playerX);
                }
            }
            
            /////////////////////////////
            
            if(playerX >= 2400 || playerX <= - 2400)
            {
                HEALTH -= 10;
                console.log(HEALTH);
            }
            
            if(HEALTH < 0)
            {
                canvas.parentNode.removeChild(canvas);
                let p = document.createElement('p');
                p.innerText = 'Вы проиграли!\nВаш счёт - ' + SCORE;
                document.body.appendChild(p);
            }
            
            /////////////////////////////

            while (pos >= N*SEGL) { pos -= N * SEGL;}
            while (pos < 0) {pos += N * SEGL;}

            ////////////////////////////

            var startPos = pos / SEGL;
            var camH = 1500 + lines[startPos].y;
            var x = 0, dx = 0;

            for(let n = startPos; n < startPos + 300; n++)
            {
                lines[n % N].project(playerX - x, camH, startPos * SEGL - (n>=N?N*SEGL:0));
                
                x += dx;
                dx += lines[n % N].curve;

                var grass, rumble, road;
                if((n % 3) / 2)
                {
                    grass = '#009A00';
                    rumble = '#FFFFFF';
                    road = 'gray';
                }
                else
                {
                    grass = '#10C810';
                    rumble = '#000000';
                    road = 'dimgray';
                }
                if (lines[n % N].Y >= maxy) continue;
                maxy = lines[n % N].Y;
                p = lines[(n-1) % N]
                Render.DrawPolygonTest(ctx, 0, p.Y, WIDTH, 0, lines[n % N].Y, WIDTH, grass);
                Render.DrawPolygonTest(ctx, p.X, p.Y, p.W * 1.2, lines[n % N].X, lines[n % N].Y, lines[n % N].W * 1.2, rumble);
                Render.DrawPolygonTest(ctx, p.X, p.Y, p.W, lines[n % N].X, lines[n % N].Y, lines[n % N].W, road);
            }
            SCORE += 10;
            pos += SPEED;
            
            console.log(press);
            
            if(!press)
            {
                ctx.drawImage(car, 750, 730 + getRandomInt(4), 422, 237.6);
            }
            else
            {
                ctx.drawImage(sonic, 750, 730 + getRandomInt(4), 422, 237.6);
            }
            press = false;

        }
    </script>
</body>
</html>